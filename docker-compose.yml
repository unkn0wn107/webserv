services:
  webserv:
    container_name: webserv-${BUILD_TYPE}
    ports:
      - "8080:8080"
      - "8081:8081"
    volumes:
      - ./site:/var/www/html
      - ./src/:/app/src/
      - ./default.conf:/app/default.conf
      - ./Makefile:/app/Makefile
    build:
      context: .
      args:
        BUILD_TYPE: ${BUILD_TYPE}
    environment:
      UID: ${MY_UID}
      GID: ${MY_GID}
      BUILD_TYPE: ${BUILD_TYPE}
    restart: unless-stopped

  webserv-dev:
    container_name: webserv-dev
    ports:
      - "8080:8080"
      - "8081:8081"
    volumes:
      - ./site:/var/www/html
      - ./src/:/app/src/
      - ./default.conf:/app/default.conf
      - ./Makefile:/app/Makefile
    build:
      context: .
      dockerfile: DockerfileDevEnv
      args:
        BUILD_TYPE: ${BUILD_TYPE}
    environment:
      UID: ${MY_UID}
      GID: ${MY_GID}
      BUILD_TYPE: ${BUILD_TYPE}
    # develop:
    #   watch:
    #     - action: rebuild
    #       path: ./src
    #       target: /app/
    #     - action: rebuild
    #       path: ./Makefile
    #       target: /app/
    #     - action: rebuild
    #       path: ./Dockerfile
    #     - action: sync+restart
    #       path: ./default.conf
    #       target: /app/default.conf

  nginx:
    container_name: nginx
    ports:
      - "${NGINX_PORT_1}:8080"
      - "${NGINX_PORT_2}:8081"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./site:/var/www/html
    build:
      context: nginx
      dockerfile: Dockerfile
    restart: unless-stopped
